### 一、ajax定义

#### 1、什么是Ajax

Ajax：即异步 JavaScript 和XML。Ajax是一种用于创建快速动态网页的技术。通过在后台与服务器进行少量数据交换，Ajax可以使网页实现异步更新。这意味着可以在不重新加载整个网页的情况下，对网页的某部分进行更新。而传统的网页(不使用 Ajax)如果需要更新内容，必需重载整个网页面。

#### 2、同步与异步的区别

同步提交：当用户发送请求时，当前页面不可以使用，服务器响应页面到客户端，响应完成，用户才可以使用页面。

异步提交：当用户发送请求时，当前页面还可以继续使用，当异步请求的数据响应给页面，页面把数据显示出来 

#### 3、ajax的工作原理

 客户端发送请求，请求交给xhr，xhr把请求提交给服务，服务器进行业务处理，服务器响应数据交给xhr对象，xhr对象接收数据，由javascript把数据写到页面上 。

![](C:\Users\Lenovo\Desktop\day04\img\ajax运行原理.jpg)

### 二、实现ajax的基本步骤

要完整实现一个AJAX异步调用和局部刷新,通常需要以下几个步骤:

1、创建XMLHttpRequest对象,即创建一个异步调用对象.
2、创建一个新的HTTP请求,并指定该HTTP请求的方法、URL及验证信息.
3、设置响应HTTP请求状态变化的函数.
4、发送HTTP请求.
5、获取异步调用返回的数据.
6、使用JavaScript和DOM实现局部刷新.

```
   function ajaxHttpRequestFunc(){
		let xmlHttpRequest;  // 创建XMLHttpRequest对象，即一个用于保存异步调用对象的变量
		if(window.ActiveXObject){ // IE浏览器的创建方式
            xmlHttpRequest = new ActiveXObject("Microsoft.XMLHTTP");
        }else if(window.XMLHttpRequest){ // Netscape浏览器中的创建方式
            xmlHttpRequest = new XMLHttpRequest();
        }
		xmlHttpRequest.onreadystatechange=function(){ // 设置响应http请求状态变化的事件
            console.log('请求过程', xmlHttpRequest.readyState);
			if(xmlHttpRequest.readyState == 4){ // 判断异步调用是否成功,若成功开始局部更新数据
				console.log('状态码为', xmlHttpRequest.status);
				if(xmlHttpRequest.status == 200) {
					console.log('异步调用返回的数据为：', xmlHttpRequest .responseText);
					document.getElementById("myDiv").innerHTML = xmlHttpRequest .responseText; // 局部刷新数据到页面
				} else { // 如果异步调用未成功,弹出警告框,并显示错误状态码
					alert("error:HTTP状态码为:"+xmlHttpRequest.status);
				}
			}
		}
		xmlHttpRequest.open("GET","https://www.runoob.com/try/ajax/ajax_info.txt",true); // 创建http请求，并指定请求得方法（get）、url（https://www.runoob.com/try/ajax/ajax_info.txt）以及验证信息
		xmlHttpRequest.send(null); // 发送请求
    }
```

**创建HTTP请求时的参数**

method：该参数用于指定HTTP的请求方法，一共有get、post、head、put、delete五种方法，常用的方法为get和post。

URL：该参数用于指定HTTP请求的URL地址，可以是绝对URL，也可以是相对URL。

flag：该参数为可选，参数值为布尔型。该参数用于指定是否使用异步方式。true表示异步、false表示同步，默认为true。

name：该参数为可选参数，用于输入用户名。如果服务器需要验证，则必须使用该参数。

password：该参数为可选，用于输入密码。若服务器需要验证，则必须使用该参数。



 **从创建XMLHttpRequest对象开始，到发送数据、接收数据、XMLHttpRequest对象一共会经历以下5中状态。** 

1. 未初始化状态。在创建完XMLHttpRequest对象时，该对象处于未初始化状态，此时XMLHttpRequest对象的readyState属性值为0。
2. 初始化状态。在创建完XMLHttpRequest对象后使用open()方法创建了HTTP请求时，该对象处于初始化状态。此时XMLHttpRequest对象的readyState属性值为1。
3. 发送数据状态。在初始化XMLHttpRequest对象后，使用send()方法发送数据时，该对象处于发送数据状态，此时XMLHttpRequest对象的readyState属性值为2。
4. 接收数据状态。Web服务器接收完数据并进行处理完毕之后，向客户端传送返回的结果。此时，XMLHttpRequest对象处于接收数据状态，XMLHttpRequest对象的readyState属性值为3。
5. 完成状态。XMLHttpRequest对象接收数据完毕后，进入完成状态，此时XMLHttpRequest对象的readyState属性值为4。此时接收完毕后的数据存入在客户端计算机的内存中，可以使用responseText属性或responseXml属性来获取数据。

### 三、promise

1. **Promise出现的原因**

   - 为了解决异步回调问题
   - 为了解决信任问题
   - 为了解决捕捉错位的能力（400，500）
   - 为了解决回调执行顺序问题

2. **概念:** 

   Promise函数是解决异步编程问题产生的。

   所谓promise，简单说就是一个容器，里面保存着某个未来才会结束的事件（通常是一个异步操作）的结果。

   从语法上说，promise是一个对象，从它可以获取异步操作的消息。**Promise 提供统一的API**，各种异步操作都可以用同样的方法进行处理。

3. **特点:**

   - 对象的状态不受外界影响，有三种状态: pending (进行中)、fulfilled(已成功)和rejected (已失败)
   - 状态的变化：
     - 从等待中到已成功（pedding ==> fulfilled）
     - 从等待中到已失败（pedding ==> rejected）
   - 一旦状态确定，便不再更改，状态凝固  ===>resolved
   - Promise 的返回值无论是不是promise函数，最终都会被封装Promise函数进行返回

4. **和事件循环的区别**

   - 事件循环一旦错过，不会再被监听到
   - Promise状态凝固，永远都可以被监听到

5. **Promise的回调函数**

   - resolve  ==> 成功的回调
   - reject  ==> 失败的回调

6. **Promise链式调用**

   形式：promise().then().then().then().catch，可以一直then下去，每一个then不会相互阻碍。

   特点：在上一个then里面，return 一个返回值，在下一个then里面可以获取到返回值。

7. **catch方法**

   在链式调用中，catch只能捕捉第一个then返回的错误信息；

   想要单独的捕捉每个then的错误信息，需要每个then 后面去跟随catch来进行捕获

8. **all方法**

   形式：Promise.all([p1,p2,p3]),then(res=> console.log(res))

   特点：

   - 接收的参数为数组[]
   - 返回值为一个数组，进行获取最终结果
   - 必须等待全部函数返回成功后，才会执行，不能单独获取任何一个函数的值

   缺点 ：

   - 任何一个函数崩掉都不能执行

9. **race方法**

   多个promise同时请求的时候，以第一个请求完成的promise状态作为整个promise的状态
   谁先执行完，返回谁，状态就是谁

10. **finally方法**

    finally()方法返回一个 Promise 。在promise结束时，无论结果是fulfilled 或者是rejected，都会执行指定的回调函数。这为在Promise是否成功完成后都需要执行的代码提供了一种方式，这避免了同样的语句需要在then()和catch()中各写一次的情况。



### 四、async和await

##### 1.概念

async：快速创建一个异步函数，且是基于promise函数封装。
在一个函数的开头添加 async，就可以使其成为一个异步函数。在异步函数中，你可以在调用一个返回Promise 的函数之前使用await关键字。
在js中，可以通过async关键字来快速创建异步函数。**异步函数也就意味着该函数的执行不会阻塞后面代码的执行**。async函数也是函数，平时我们怎么使用函数就怎么使用它，直接加括号调用就可以了。async函数返回的是一个promise对象，如果要获取到promise返回值，我们应该用then方法。

##### 2.特点

优点：

它是把异步请求变成同步执行的.async放在最近函数外调用，返回的是promise对象。

1. 方便级联调用：即调用依次发生的场景;
2. 同步代码编写方式：Promise使用then函数进行链式调用，是一种从左向右的横向写法，async、await从上到下，顺序执行，就像写同步代码一样，更符合代码编写习惯；

缺点：
没有catch错误处理，需要用js原生的try.catch进行错误处理。

##### 3.调用

调用异步函数的时候，可以直接在函数前使用await关健字来对其进行调用。

调用await的时候，他会等待Promise执行出结果后将结果返回，可以通过变量进行接收结果。
**注意**：await并不是将异步函数变成同步函数，只是改变了异步函数的调用方式。

### 五、axios

 Axios 是一个基于 *[promise](https://javascript.info/promise-basics)* 网络请求库，作用于[`node.js`](https://nodejs.org/) 和浏览器中。 它是 *[isomorphic](https://www.lullabot.com/articles/what-is-an-isomorphic-application)* 的(即同一套代码可以运行在浏览器和node.js中)。在服务端它使用原生 node.js `http` 模块, 而在客户端 (浏览端) 则使用 XMLHttpRequests。 

- 从浏览器创建 [XMLHttpRequests](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest)
- 从 node.js 创建 [http](http://nodejs.org/api/http.html) 请求
- 支持 [Promise](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise) API
- 拦截请求和响应
- 转换请求和响应数据
- 取消请求
- 自动转换JSON数据
- 客户端支持防御XSRF

```
const instance = axios.create({
  baseURL: 'https://some-domain.com/api/',
  timeout: 1000,
  headers: {'X-Custom-Header': 'foobar'}
});

//拦截器：
// 添加请求拦截器
axios.interceptors.request.use(function (config) {
    // 在发送请求之前做些什么
    return config;
  }, function (error) {
    // 对请求错误做些什么
    return Promise.reject(error);
  });

// 添加响应拦截器
axios.interceptors.response.use(function (response) {
    // 2xx 范围内的状态码都会触发该函数。
    // 对响应数据做点什么
    return response;
  }, function (error) {
    // 超出 2xx 范围的状态码都会触发该函数。
    // 对响应错误做点什么
    return Promise.reject(error);
  });
```











